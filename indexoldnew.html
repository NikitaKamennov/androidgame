<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#2196F3" />
  <title>Kamnefon Wrapper</title>
  <link rel="manifest" href="/manifest.json" />
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; padding: 16px; background: #0f172a; color: #e2e8f0; }
    .card { max-width: 720px; margin: 0 auto; background: #111827; border: 1px solid #1f2937; border-radius: 12px; padding: 20px; }
    h1 { margin: 0 0 12px; font-size: 22px; }
    p { margin: 6px 0 12px; color: #94a3b8; }
    label { display: block; margin: 10px 0 6px; font-size: 14px; color: #cbd5e1; }
    input { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #334155; background: #0b1220; color: #e2e8f0; outline: none; }
    input::placeholder { color: #64748b; }
    .row { display: flex; gap: 12px; flex-wrap: wrap; margin-top: 14px; }
    .btn { cursor: pointer; border: none; border-radius: 10px; padding: 12px 16px; background: #2563eb; color: white; font-weight: 600; }
    .btn.secondary { background: #334155; color: #e2e8f0; }
    .btn.warn { background: #b91c1c; }
    .hint { font-size: 13px; color: #94a3b8; }
    .ok { color: #22c55e; }
    .err { color: #ef4444; }
    .sep { height: 1px; background: #1f2937; margin: 16px 0; }
    .hidden { display: none; }
  </style>
</head>
<body>
  <div class="card">
    <h1>Настройка звонков</h1>
    <p>На первом запуске выберите ссылку приглашения или хост. Разрешите уведомления и доступ к микрофону/камере. Затем откроется основное приложение kamnefon.ru. [Локальные уведомления используются через плагин Capacitor Local Notifications.]</p>

    <div id="status"></div>

    <label for="remoteInput">Ссылка приглашения ИЛИ хост (по умолчанию https://kamnefon.ru):</label>
    <input id="remoteInput" type="text" placeholder="например: https://kamnefon.ru/invite/XXXX-UUID или kamnefon.ru" />

    <div class="row">
      <button id="detectBtn" class="btn secondary">Подставить kamnefon.ru</button>
      <button id="saveBtn" class="btn">Сохранить</button>
      <button id="resetBtn" class="btn warn">Сбросить</button>
    </div>

    <div class="sep"></div>

    <h1>Разрешения</h1>
    <p class="hint">Сначала уведомления (Android 13+ покажет системный запрос), затем микрофон/камера. [LocalNotifications.checkPermissions/requestPermissions].</p>
    <div class="row">
      <button id="permNotifBtn" class="btn">Разрешить уведомления</button>
      <button id="permAVBtn" class="btn">Разрешить микрофон/камеру</button>
    </div>
    <p id="permNotifState" class="hint"></p>
    <p id="permAVState" class="hint"></p>

    <div class="sep"></div>

    <h1>Проверка уведомлений</h1>
    <div class="row">
      <button id="testNotifBtn" class="btn secondary">Тест: входящий звонок</button>
    </div>

    <div class="sep"></div>

    <div class="row">
      <button id="openBtn" class="btn">Открыть приложение</button>
    </div>
    <p class="hint" style="margin-top: 8px;">
      После сохранения пути и выдачи разрешений нажмите «Открыть приложение». В дальнейшем оболочка будет запускать адрес из памяти автоматически. Чтобы сменить адрес — нажмите «Сбросить».
    </p>
  </div>

  <div id="appHost" class="hidden" style="position:fixed; inset:0; background:#000;">
   <!-- iframe будет создан динамически -->
 </div>

  <!-- ВАЖНО: Инициализируем cap-notify.ts, чтобы появился window.capNotify -->
  <script type="module" src="/src/cap-notify.ts"></script>

  <script type="module" src="/src/cap-push.ts"></script>


  <script type="module">
    // Глобальный хелпер: безопасно вызвать window.capNotify.*
    function capNotify() {
      return (window).capNotify;
    }

    // Состояние UI
    let capReady = false;
    const statusEl = document.getElementById('status');
    const notifStateEl = document.getElementById('permNotifState');
    const avStateEl = document.getElementById('permAVState');
    const inputEl = document.getElementById('remoteInput');
    const LS_KEY = 'kamnefon.remoteUrl';

    function setStatus(html) { statusEl.innerHTML = html; }

    function normalizeRemote(input) {
      let s = (input || '').trim();
      if (!s) return 'https://kamnefon.ru';
      if (!/^https?:\/\//i.test(s)) {
        if (s.startsWith('/')) {
          s = 'https://kamnefon.ru' + s;
        } else if (s.startsWith('invite/')) {
          s = 'https://kamnefon.ru/' + s;
        } else if (s.includes('.')) {
          s = 'https://' + s;
        } else {
          s = 'https://kamnefon.ru';
        }
      }
      return s;
    }

    function saveRemote(url) {
      localStorage.setItem(LS_KEY, url);
      setStatus('<span class="ok">Сохранено:</span> ' + url);
    }

    function loadRemote() {
      return localStorage.getItem(LS_KEY);
    }

    function resetRemote() {
      localStorage.removeItem(LS_KEY);
      setStatus('<span class="ok">Сброшено. Введите ссылку/хост и сохраните заново.</span>');
    }

    async function ensureNotifPerms() {
      try {
        if (!capReady || !capNotify()) {
          setStatus('<span class="err">Плагин уведомлений не инициализирован.</span>');
          return false;
        }
        await capNotify().initNotifications(); // создаст каналы и запросит права
        notifStateEl.textContent = 'Уведомления: разрешены или не требуются (Android < 13).';
        return true;
      } catch (e) {
        notifStateEl.textContent = 'Уведомления: отказ или ошибка.';
        return false;
      }
    }

    async function ensureAVPerms() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true, video: true });
        stream.getTracks().forEach(t => t.stop());
        avStateEl.textContent = 'Микрофон/камера: разрешены.';
        return true;
      } catch (e) {
        avStateEl.textContent = 'Микрофон/камера: отказ или ошибка.';
        return false;
      }
    }

    document.getElementById('detectBtn').addEventListener('click', () => {
      inputEl.value = 'https://kamnefon.ru';
    });
    document.getElementById('saveBtn').addEventListener('click', () => {
      const url = normalizeRemote(inputEl.value);
      saveRemote(url);
    });
    document.getElementById('resetBtn').addEventListener('click', resetRemote);
    document.getElementById('permNotifBtn').addEventListener('click', ensureNotifPerms);
    document.getElementById('permAVBtn').addEventListener('click', ensureAVPerms);

    document.getElementById('testNotifBtn').addEventListener('click', async () => {
      try {
        await ensureNotifPerms();
        await capNotify().presentIncomingCall('Тестовый звонок', 'Поступает вызов…');
        setStatus('<span class="ok">Тестовое уведомление отправлено.</span>');
      } catch {
        setStatus('<span class="err">Не удалось отправить тестовое уведомление.</span>');
      }
    });

    document.getElementById('openBtn').addEventListener('click', async () => {
  const saved = loadRemote() || normalizeRemote(inputEl.value);
  saveRemote(saved);
  await openInIframe(saved);
});

// ДОБАВИТЬ эти функции рядом (в том же <script type="module">)
let __iframeEl = null;
let __iframeOrigin = null;

// Глобальный helper, чтобы cap-push мог постить в iframe
// @ts-ignore
(window).__postToIframe = function (msg) {
  if (__iframeEl && __iframeOrigin) {
    try { __iframeEl.contentWindow.postMessage(msg, __iframeOrigin); } catch {}
  }
};

async function openInIframe(url) {
  const host = document.getElementById('appHost');
  // Очищаем и показываем хост
  host.innerHTML = '';
  host.classList.remove('hidden');

  // Определим origin, чтобы фильтровать сообщения
  __iframeOrigin = new URL(url).origin;

  // Создаём iframe
  const ifr = document.createElement('iframe');
  ifr.src = url;
  ifr.style.cssText = 'width:100%;height:100%;border:0;display:block;';
  // Разрешаем микрофон/камеру и др. внутри iframe
  ifr.allow = 'camera; microphone; autoplay; fullscreen; clipboard-read; clipboard-write';
  host.appendChild(ifr);
  __iframeEl = ifr;

  // Ждём загрузку первого документа и делаем хэндшейк
  ifr.addEventListener('load', async () => {
    // 1) Сообщаем о возможностях (локальные уведомления/пуш)
    (window).__postToIframe({
      type: 'capabilities',
      localNotifications: !!(window).capNotify,
      push: !!(window).capPush,
    });

    // 2) Ини push: получим/обновим токен и отправим его в iframe
    try {
      // Инициируем push (первый запуск может показать системный запрос)
      const token = await (window).capPush?.initPush();
      if (token) {
        (window).__postToIframe({ type: 'push-token', token });
      } else {
        // Может уже был сохранён ранее
        const t = (window).capPush?.getPushToken?.();
        if (t) (window).__postToIframe({ type: 'push-token', token: t });
      }
    } catch {}
  });
}

// ДОПОЛНИТЬ существующий window.addEventListener('message', ...) обработчик:
window.addEventListener('message', async (ev) => {
  // Уже есть проверка origin — ок
  try {
    const origin = new URL(loadRemote() || 'https://kamnefon.ru').origin;
    if (ev.origin !== origin) return;
  } catch {}

  const data = ev.data || {};

  // ИМЕЮЩЕЕСЯ: входящий звонок по postMessage из kamnefon.ru
  if (data && data.type === 'incoming-call') {
    await ensureNotifPerms();
    const title = data.title || 'Входящий звонок';
    const body = data.body || (data.from ? `Звонит: ${data.from}` : 'Поступает вызов…');
    await capNotify().presentIncomingCall(title, body);
    return;
  }

  // ДОБАВИТЬ: kamnefon.ru может запросить пуш-токен повторно
  if (data && data.type === 'request-push-token') {
    const t = (window).capPush?.getPushToken?.();
    if (t) (window).__postToIframe({ type: 'push-token', token: t });
    return;
  }

  // (опционально) Логи из iframe
  if (data && data.type === 'log') {
    console.log('[IFRAME]', data.payload);
    return;
  }
});

    // Автоинициализация
    (async function boot() {
      try {
        capReady = !!capNotify();
        if (capReady) {
          await capNotify().initNotifications();
        }
      } catch {}
      const saved = loadRemote();
      if (saved) {
        inputEl.value = saved;
      }

      window.addEventListener('message', async (ev) => {
        try {
          const origin = new URL(loadRemote() || 'https://kamnefon.ru').origin;
          if (ev.origin !== origin) return;
        } catch {}
        const data = ev.data || {};
        if (data && data.type === 'incoming-call') {
          await ensureNotifPerms();
          const title = data.title || 'Входящий звонок';
          const body = data.body || (data.from ? `Звонит: ${data.from}` : 'Поступает вызов…');
          await capNotify().presentIncomingCall(title, body);
        }
      });
    })();
  </script>
</body>
</html>