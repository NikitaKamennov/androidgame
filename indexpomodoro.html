<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–ü–æ–º–æ–¥–æ—Ä–æ –¢–∞–π–º–µ—Ä ‚Äî –§–æ–∫—É—Å, –ü–µ—Ä–µ—Ä—ã–≤—ã, –ó–≤—É–∫, –ó–∞–¥–∞—á–∏</title>
  <script type="module" src="/src/cap-notify.ts"></script>
  <style>
    :root {
      --bg: #0f1222;
      --panel: #141833;
      --text: #e9ecff;
      --muted: #a9b1d6;
      --accent: #7c9fff;
      --accent-2: #00d4ff;
      --danger: #ff5a7a;
      --ok: #2ecc71;
      --warn: #ffb74d;
      --ring: #8ab4ff;
      --ring-bg: rgba(138,180,255,0.15);
      --border: #2a2f55;
      --chip: #1a1f40;
      --shadow: 0 10px 40px rgba(0,0,0,0.35);
    }
    .light {
      --bg: #eef3ff;
      --panel: #ffffff;
      --text: #1a1f36;
      --muted: #5a668a;
      --accent: #3b6cff;
      --accent-2: #00a3ff;
      --danger: #e53935;
      --ok: #2e7d32;
      --warn: #f59f00;
      --ring: #3b6cff;
      --ring-bg: rgba(59,108,255,0.12);
      --border: #e6e9f5;
      --chip: #f6f8ff;
      --shadow: 0 10px 30px rgba(17,38,146,0.08);
    }
    html,body {
      height: 100%;
    }
    body {
      margin: 0;
      background:
        radial-gradient(1200px 600px at 10% 0%, rgba(0,212,255,0.12), transparent 60%),
        radial-gradient(1000px 500px at 90% 10%, rgba(124,159,255,0.15), transparent 70%),
        linear-gradient(180deg, var(--bg), #0b0e1b 60%, var(--bg));
      color: var(--text);
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    .container {
      max-width: 1200px;
      margin: 24px auto;
      padding: 0 16px;
      display: grid;
      grid-template-columns: 1.1fr 0.9fr;
      gap: 20px;
    }
    @media (max-width: 980px) {
      .container { grid-template-columns: 1fr; }
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 8px;
      padding: 12px 16px;
    }
    .brand {
      display: flex; align-items: center; gap: 10px;
      font-weight: 700; letter-spacing: 0.3px;
    }
    .brand .logo {
      width: 36px; height: 36px; border-radius: 10px;
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      box-shadow: 0 8px 24px rgba(0,212,255,0.3), inset 0 0 0 2px rgba(255,255,255,0.2);
    }
    .brand .title { font-size: 18px; }

    .theme-toggle {
      display: inline-flex; align-items: center; gap: 8px;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 6px 10px;
      cursor: pointer;
      user-select: none;
      box-shadow: var(--shadow);
    }
    .theme-toggle input { display: none; }
    .theme-toggle .dot {
      width: 20px; height: 20px; border-radius: 50%;
      background: linear-gradient(135deg, #ffd54f, #ff8f00);
      box-shadow: inset 0 0 0 2px rgba(255,255,255,0.35);
    }
    .theme-label { color: var(--muted); font-size: 13px; }

    .panel {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 18px;
      box-shadow: var(--shadow);
    }

    /* Top progress bar */
    .top-progress {
      position: fixed;
      top: 0; left: 0; height: 4px; width: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.07));
      z-index: 50;
    }
    .top-progress .bar {
      height: 100%; width: 0%;
      background: linear-gradient(90deg, var(--accent), var(--accent-2));
      transition: width 0.2s ease-out;
      box-shadow: 0 0 10px var(--accent-2);
    }

    /* Main timer panel */
    .timer-panel {
      display: grid;
      grid-template-rows: auto 1fr auto;
      gap: 12px;
      min-height: 540px;
    }
    .mode-chips {
      display: flex; gap: 8px; flex-wrap: wrap;
    }
    .chip {
      background: var(--chip);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 8px 12px;
      border-radius: 999px;
      font-size: 13px;
      cursor: pointer;
      user-select: none;
      transition: transform .05s;
    }
    .chip:hover { transform: translateY(-1px); }
    .chip.active {
      background: linear-gradient(135deg, rgba(124,159,255,0.22), rgba(0,212,255,0.18));
      border-color: transparent;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.15);
    }
    .grid-center {
      display: grid; place-items: center; padding: 8px 0;
    }
    .timer-wrap {
      position: relative;
      width: 360px; height: 360px;
      display: grid; place-items: center;
    }
    @media (max-width: 420px) {
      .timer-wrap { width: 300px; height: 300px; }
    }
    .timer-value {
      font-size: 68px; font-weight: 800; letter-spacing: 1px;
      text-shadow: 0 6px 30px rgba(0,0,0,0.35);
    }
    .subnote {
      margin-top: 6px; color: var(--muted); font-size: 13px;
    }
    .controls {
      display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; margin-top: 10px;
    }
    .btn {
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      color: #001221;
      border: none;
      padding: 10px 14px;
      border-radius: 12px; font-weight: 700;
      cursor: pointer; box-shadow: var(--shadow);
    }
    .btn.secondary {
      background: var(--chip);
      color: var(--text);
      border: 1px solid var(--border);
      font-weight: 600;
    }
    .btn.danger {
      background: linear-gradient(135deg, #ff6b6b, #ff2e63);
      color: #fff;
    }
    .btn:disabled { opacity: 0.6; cursor: not-allowed; }

    /* ring */
    svg#ring { position: absolute; inset: 0; }
    .ring-bg { stroke: var(--ring-bg); }
    .ring-fg { stroke: var(--ring); filter: drop-shadow(0 0 10px rgba(138,180,255,0.5)); }

    /* right side */
    .side {
      display: grid; gap: 16px;
    }
    .section-title {
      font-size: 14px; color: var(--muted); margin: 0 0 10px; letter-spacing: .3px;
    }
    .row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
    }
    .form-row { display: flex; align-items: center; justify-content: space-between; gap: 10px; margin: 10px 0; }
    .input, select {
      background: var(--chip); color: var(--text);
      border: 1px solid var(--border);
      border-radius: 10px; padding: 10px 12px;
      outline: none; width: 100%;
    }
    .range { width: 100%; }
    .switch {
      display: inline-flex; align-items: center; gap: 8px; cursor: pointer; user-select: none;
    }
    .switch input { display: none; }
    .switch .track {
      width: 44px; height: 24px; background: var(--chip); border: 1px solid var(--border); border-radius: 999px; position: relative;
    }
    .switch .thumb {
      position: absolute; top: 50%; transform: translateY(-50%);
      left: 3px; width: 18px; height: 18px; border-radius: 50%;
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      transition: left .15s;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    }
    .switch input:checked + .track .thumb { left: 23px; }

    /* tasks */
    .tasks { display: grid; gap: 10px; }
    .task {
      display: grid; grid-template-columns: auto 1fr auto; gap: 10px; align-items: center;
      padding: 10px; border-radius: 12px; background: var(--chip); border: 1px solid var(--border);
    }
    .task input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; }
    .task .title { font-weight: 600; }
    .task .meta { color: var(--muted); font-size: 12px; }
    .task.active { box-shadow: inset 0 0 0 2px var(--accent); }
    .task .actions { display: flex; gap: 6px; }
    .task .icon-btn {
      background: transparent; color: var(--muted); border: 1px solid var(--border);
      padding: 6px 8px; border-radius: 8px; cursor: pointer;
    }

    /* stats */
    .stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
    @media (max-width: 500px) { .stats { grid-template-columns: 1fr; } }
    .stat {
      background: var(--chip); border: 1px solid var(--border); border-radius: 12px;
      padding: 12px; display: grid; gap: 6px;
    }
    .stat .label { color: var(--muted); font-size: 12px; }
    .stat .value { font-size: 18px; font-weight: 800; }

    footer {
      opacity: 0.8; text-align: center; font-size: 12px; color: var(--muted); padding: 8px 16px 22px;
    }
    .kbd { font-family: ui-monospace, SFMono-Regular, Menlo, monospace; font-size: 12px; background: var(--chip); border: 1px solid var(--border); padding: 2px 6px; border-radius: 6px; }
    /* 1) –õ–µ–π–±–ª—ã —Å–≤–µ—Ä—Ö—É —Å –Ω–µ–±–æ–ª—å—à–∏–º –æ—Ç—Å—Ç—É–ø–æ–º, —Ç–æ–ª—å–∫–æ –≤ .row —á—Ç–æ–±—ã –Ω–µ –∑–∞–¥–µ—Ç—å –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª–∏ .switch */
.row > div > label {
  display: block;
  margin-bottom: 6px;
}

/* 2) –ù–µ –¥–∞–≤–∞—Ç—å –∫–æ–ª–æ–Ω–∫–∞–º "—Ä–∞—Å–ø–∏—Ä–∞—Ç—å" —Å–µ—Ç–∫—É */
.row > div {
  min-width: 0;
}

/* 3) –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ä–∞—Å—á–µ—Ç —à–∏—Ä–∏–Ω—ã –∏–Ω–ø—É—Ç–æ–≤ */
.input, select {
  box-sizing: border-box;
}

/* 4) –ù–∞ —É–∑–∫–∏—Ö —ç–∫—Ä–∞–Ω–∞—Ö —Å–∫–ª–∞–¥—ã–≤–∞–µ–º .row –≤ –æ–¥–Ω—É –∫–æ–ª–æ–Ω–∫—É */
@media (max-width: 640px) {
  .side .row {
    grid-template-columns: 1fr;
    gap: 10px;
  }
}

/* 5) –§–æ—Ä–º-—Å—Ç—Ä–æ–∫–∏ (—Å–ª–∞–π–¥–µ—Ä, –∫–Ω–æ–ø–∫–∏) ‚Äî –ø–µ—Ä–µ–Ω–æ—Å –ø–æ —Å—Ç—Ä–æ–∫–∞–º –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
@media (max-width: 640px) {
  .form-row {
    flex-wrap: wrap;
    align-items: stretch;
  }
  .form-row > * {
    flex: 1 1 100%;
  }
  /* –°–ª–∞–π–¥–µ—Ä –ø–æ–¥ –ø–æ–¥–ø–∏—Å—å—é "–ì—Ä–æ–º–∫–æ—Å—Ç—å" ‚Äî –º–∞–ª–µ–Ω—å–∫–∏–π –æ—Ç—Å—Ç—É–ø —Å–≤–µ—Ä—Ö—É */
  .form-row .range {
    margin-top: 8px;
  }
  /* –ü–∞—Ä–∞ –∫–Ω–æ–ø–æ–∫ "–¢–µ—Å—Ç –∑–≤—É–∫–∞" / "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ" ‚Äî –¥—Ä—É–≥ –ø–æ–¥ –¥—Ä—É–≥–æ–º —Å –ø—Ä–æ–º–µ–∂—É—Ç–∫–æ–º */
  .form-row .btn {
    width: 100%;
  }
}
  </style>
</head>
<body>
  <div class="top-progress"><div id="topBar" class="bar"></div></div>
  <header>
  <div class="brand">
  <div class="logo" aria-hidden="true"></div>
  <div class="title">–ü–æ–º–æ–¥–æ—Ä–æ –¢–∞–π–º–µ—Ä</div>
  </div>
  <label class="theme-toggle" title="–¢–µ–º–∞: –°–≤–µ—Ç–ª–∞—è/–¢—ë–º–Ω–∞—è">
  <input id="themeToggle" type="checkbox" />
  <span class="dot"></span>
  <span class="theme-label" id="themeLabel">–¢—ë–º–Ω–∞—è</span>
  </label>
  </header>
  <div class="container">
  <!-- Main Timer -->
  <section class="panel timer-panel" aria-label="–¢–∞–π–º–µ—Ä">
  <div class="mode-chips" role="tablist" aria-label="–†–µ–∂–∏–º—ã —Ç–∞–π–º–µ—Ä–∞">
  <button id="chipFocus" class="chip active" role="tab" aria-selected="true">–§–æ–∫—É—Å</button>
  <button id="chipShort" class="chip" role="tab">–ö–æ—Ä–æ—Ç–∫–∏–π –ø–µ—Ä–µ—Ä—ã–≤</button>
  <button id="chipLong" class="chip" role="tab">–î–ª–∏–Ω–Ω—ã–π –ø–µ—Ä–µ—Ä—ã–≤</button>
  </div>
  <div class="grid-center">
  <div class="timer-wrap">
  <svg id="ring" viewBox="0 0 360 360" width="100%" height="100%" aria-hidden="true">
  <defs>
  <linearGradient id="ringGrad" x1="0%" y1="0%" x2="100%" y2="0%">
  <stop offset="0%" stop-color="var(--accent)" />
  <stop offset="100%" stop-color="var(--accent-2)" />
  </linearGradient>
  </defs>
  <circle class="ring-bg" cx="180" cy="180" r="150" fill="none" stroke-width="22" />
  <circle id="ringFg" class="ring-fg" cx="180" cy="180" r="150" fill="none" stroke="url(#ringGrad)" stroke-width="22"
  stroke-linecap="round" stroke-dasharray="942" stroke-dashoffset="0" transform="rotate(-90 180 180)" />
  </svg>
  <div id="time" class="timer-value" aria-live="polite">25:00</div>
  </div>
  
  <!-- –í—ã–Ω–µ—Å–µ–Ω–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ —Ç–µ–∫—É—â–µ–π –∑–∞–¥–∞—á–∏ –ø–æ–¥ –∫—Ä—É–≥–æ–º -->
  <div id="subnote" class="subnote">–ì–æ—Ç–æ–≤—ã –∫ —Ä–∞–±–æ—Ç–µ. –¢–µ–∫—É—â–∞—è –∑–∞–¥–∞—á–∞: ‚Äî</div>
  
  <div class="controls">
  <button id="btnStartPause" class="btn" aria-label="–°—Ç–∞—Ä—Ç/–ü–∞—É–∑–∞ (Space)">–°—Ç–∞—Ä—Ç</button>
  <button id="btnReset" class="btn secondary" aria-label="–°–±—Ä–æ—Å (R)">–°–±—Ä–æ—Å</button>
  <button id="btnSkip" class="btn secondary" aria-label="–°–ª–µ–¥—É—é—â–∏–π —Ä–µ–∂–∏–º (N)">–ü—Ä–æ–ø—É—Å–∫</button>
  </div>
  <!-- <div class="subnote">
  –ì–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏: <span class="kbd">Space</span> –°—Ç–∞—Ä—Ç/–ü–∞—É–∑–∞ ¬∑ <span class="kbd">R</span> –°–±—Ä–æ—Å ¬∑ <span class="kbd">N</span> –°–ª–µ–¥—É—é—â–∏–π ¬∑
  <span class="kbd">1</span>/<span class="kbd">2</span>/<span class="kbd">3</span> –†–µ–∂–∏–º
  </div> -->
  </div>
  <div class="stats">
  <div class="stat">
  <div class="label">–°–µ–≥–æ–¥–Ω—è –ø–æ–º–∏–¥–æ—Ä–æ–∫</div>
  <div id="statToday" class="value">0</div>
  </div>
  <div class="stat">
  <div class="label">–§–æ–∫—É—Å (—Å–µ–≥–æ–¥–Ω—è)</div>
  <div id="statFocusTime" class="value">00:00</div>
  </div>
  <div class="stat">
  <div class="label">–¶–∏–∫–ª –¥–æ –¥–ª–∏–Ω–Ω–æ–≥–æ –ø–µ—Ä–µ—Ä—ã–≤–∞</div>
  <div id="statCycle" class="value">1 / 4</div>
  </div>
  </div>
  </section>
  <!-- Side settings and tasks -->
  <aside class="side">
  <section class="panel" aria-label="–ù–∞—Å—Ç—Ä–æ–π–∫–∏">
  <h3 class="section-title">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
  <div class="row">
  <div>
  <label>–§–æ–∫—É—Å (–º–∏–Ω)</label>
  <input id="inpFocus" class="input" type="number" min="1" max="120" step="1" />
  </div>
  <div>
  <label>–ö–æ—Ä–æ—Ç–∫–∏–π –ø–µ—Ä–µ—Ä—ã–≤ (–º–∏–Ω)</label>
  <input id="inpShort" class="input" type="number" min="1" max="60" step="1" />
  </div>
  </div>
  <div class="row">
  <div>
  <label>–î–ª–∏–Ω–Ω—ã–π –ø–µ—Ä–µ—Ä—ã–≤ (–º–∏–Ω)</label>
  <input id="inpLong" class="input" type="number" min="1" max="60" step="1" />
  </div>
  <div>
  <label>–î–ª–∏–Ω–Ω—ã–π –∫–∞–∂–¥—ã–µ</label>
  <select id="selEvery" class="input">
  <option value="3">3</option>
  <option value="4" selected>4</option>
  <option value="5">5</option>
  </select>
  </div>
  </div>
  <div class="form-row">
  <label class="switch">
  <input id="chkAutostart" type="checkbox" />
  <span class="track"><span class="thumb"></span></span>
  <span>–ê–≤—Ç–æ–∑–∞–ø—É—Å–∫ —Å–ª–µ–¥—É—é—â–µ–π —Å–µ—Å—Å–∏–∏</span>
  </label>
  </div>
  <div class="form-row">
  <label class="switch">
  <input id="chkSound" type="checkbox" />
  <span class="track"><span class="thumb"></span></span>
  <span>–ó–≤—É–∫ –ø–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—é</span>
  </label>
  </div>
  <div class="form-row">
  <span>–ì—Ä–æ–º–∫–æ—Å—Ç—å</span>
  <input id="rngVolume" class="range" type="range" min="0" max="1" step="0.01" />
  </div>
  <div class="form-row">
  <label class="switch">
  <input id="chkTick" type="checkbox" />
  <span class="track"><span class="thumb"></span></span>
  <span>–¢–∏–∫ –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É</span>
  </label>
  </div>
  <div class="form-row">
  <button id="btnTestSound" class="btn secondary">–¢–µ—Å—Ç –∑–≤—É–∫–∞</button>
  <button id="btnNotify" class="btn secondary">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ</button>
  </div>
  </section>
  <section class="panel" aria-label="–ó–∞–¥–∞—á–∏">
  <h3 class="section-title">–ó–∞–¥–∞—á–∏</h3>
  <div class="form-row">
  <input id="taskInput" class="input" placeholder="–ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞..." />
  <button id="btnAddTask" class="btn">–î–æ–±–∞–≤–∏—Ç—å</button>
  </div>
  <div id="tasks" class="tasks" aria-live="polite"></div>
  </section>
  </aside>
  </div>

  <footer>
    –ü–æ–º–æ–¥–æ—Ä–æ –ø–æ–º–æ–≥–∞–µ—Ç —Å–æ—Å—Ä–µ–¥–æ—Ç–æ—á–∏—Ç—å—Å—è: —Ä–∞–±–æ—Ç–∞–π—Ç–µ –ø–æ 25 –º–∏–Ω—É—Ç, –∑–∞—Ç–µ–º –æ—Ç–¥—ã—Ö–∞–π—Ç–µ 5 –º–∏–Ω—É—Ç. –ö–∞–∂–¥—ã–µ 4 –ø–æ–º–∏–¥–æ—Ä–∫–∏ ‚Äî –¥–ª–∏–Ω–Ω—ã–π –ø–µ—Ä–µ—Ä—ã–≤.
    –°–¥–µ–ª–∞–π—Ç–µ –ª–µ–≥–∫—É—é –∑–∞—Ä—è–¥–∫—É. –ü—Ä–∏—Å–µ–¥–∞–Ω–∏—è, –±–µ–≥ –Ω–∞ –º–µ—Å—Ç–µ. 
  </footer>

  <script>
    // ---- –°–æ—Å—Ç–æ—è–Ω–∏–µ / LocalStorage
    const LS_SETTINGS = 'pomodoro_settings_v1';
    const LS_STATE = 'pomodoro_state_v1';
    const LS_TASKS = 'pomodoro_tasks_v1';
    const ringFg = document.getElementById('ringFg');
    const timeEl = document.getElementById('time');
    const subnoteEl = document.getElementById('subnote');
    const topBar = document.getElementById('topBar');
    
    const chipFocus = document.getElementById('chipFocus');
    const chipShort = document.getElementById('chipShort');
    const chipLong  = document.getElementById('chipLong');
    
    const btnStartPause = document.getElementById('btnStartPause');
    const btnReset = document.getElementById('btnReset');
    const btnSkip = document.getElementById('btnSkip');
    
    const statToday = document.getElementById('statToday');
    const statFocusTime = document.getElementById('statFocusTime');
    const statCycle = document.getElementById('statCycle');
    
    const inpFocus = document.getElementById('inpFocus');
    const inpShort = document.getElementById('inpShort');
    const inpLong  = document.getElementById('inpLong');
    const selEvery = document.getElementById('selEvery');
    const chkAutostart = document.getElementById('chkAutostart');
    const chkSound = document.getElementById('chkSound');
    const chkTick = document.getElementById('chkTick');
    const rngVolume = document.getElementById('rngVolume');
    const btnTestSound = document.getElementById('btnTestSound');
    const btnNotify = document.getElementById('btnNotify');
    const themeToggle = document.getElementById('themeToggle');
    const themeLabel = document.getElementById('themeLabel');
    
    const tasksWrap = document.getElementById('tasks');
    const taskInput = document.getElementById('taskInput');
    const btnAddTask = document.getElementById('btnAddTask');
    
    const defaultSettings = {
      focusMin: 25, shortMin: 5, longMin: 15, longEvery: 4,
      autostart: false, sound: true, tick: false, volume: 0.6,
      theme: 'dark'
    };
    let settings = load(LS_SETTINGS, defaultSettings);
    
    const defaultState = {
      mode: 'focus',  // 'focus' | 'short' | 'long'
      running: false,
      endAt: 0,       // timestamp ms
      remainSec: 25*60,
      cycleCount: 0,  // –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã—Ö —Ñ–æ–∫—É—Å–æ–≤ –≤ —Ç–µ–∫—É—â–µ–º —Ü–∏–∫–ª–µ
      today: todayKey(),
      todayPomos: 0,
      todayFocusSec: 0,
      activeTaskId: null
    };
    let state = normalizeState(load(LS_STATE, defaultState));
    let tasks = load(LS_TASKS, []);
    
    function load(key, fallback) {
      try {
        const raw = localStorage.getItem(key);
        if (!raw) return structuredClone(fallback);
        const data = JSON.parse(raw);
        return Object.assign(structuredClone(fallback), data);
      } catch {
        return structuredClone(fallback);
      }
    }
    function save(key, data) {
      localStorage.setItem(key, JSON.stringify(data));
    }
    function todayKey() {
      const d = new Date();
      return d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0');
    }
    function normalizeState(s) {
      // –µ—Å–ª–∏ —Å–º–µ–Ω–∏–ª—Å—è –¥–µ–Ω—å ‚Äî –æ–±–Ω—É–ª—è–µ–º –¥–Ω–µ–≤–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
      if (s.today !== todayKey()) {
        s.today = todayKey();
        s.todayPomos = 0;
        s.todayFocusSec = 0;
      }
      return s;
    }
    
    // ---- –ê—É–¥–∏–æ / –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
    let audioCtx = null;
    function ensureAudio() {
      if (!audioCtx) {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      }
      if (audioCtx.state === 'suspended') audioCtx.resume();
    }
    function playBeep(seq = 'end') {
      if (!settings.sound) return;
      ensureAudio();
      const ctx = audioCtx;
      const now = ctx.currentTime;
      const v = ctx.createGain();
      v.gain.value = settings.volume;
      v.connect(ctx.destination);
    
      const o = ctx.createOscillator();
      o.type = 'sine';
      o.connect(v);
    
      // –º–µ–ª–æ–¥–∏–∏
      const patterns = {
        end: [880, 988, 1047],         // A5 B5 C6
        start: [523, 659, 784],        // C5 E5 G5
        tick: [1200]                   // –∫–æ—Ä–æ—Ç–∫–∏–π –∫–ª–∏–∫
      };
      const freqs = patterns[seq] || patterns.end;
    
      let t = now;
      const step = seq === 'tick' ? 0.02 : 0.12;
      freqs.forEach((f, idx) => {
        o.frequency.setValueAtTime(f, t);
        v.gain.setValueAtTime(settings.volume, t);
        v.gain.exponentialRampToValueAtTime(0.001, t + step - 0.01);
        t += step;
        if (idx === freqs.length - 1) {
          // –Ω–µ–±–æ–ª—å—à–æ–π —Ö–≤–æ—Å—Ç
          v.gain.setValueAtTime(0.0001, t + 0.02);
        }
      });
      o.start(now);
      o.stop(now + (seq === 'tick' ? 0.06 : 0.45));
      o.onended = () => { v.disconnect(); o.disconnect(); };
    }
    
    function notify(title, body) {
      if (!('Notification' in window)) return;
      if (Notification.permission === 'granted') {
        const n = new Notification(title, { body });
        setTimeout(() => n.close(), 4000);
      }
    }
    
    // ---- –¢–∞–π–º–µ—Ä
    
    function modeDurationSec(mode) {
      if (mode === 'focus') return Math.max(1, Number(settings.focusMin)) * 60;
      if (mode === 'short') return Math.max(1, Number(settings.shortMin)) * 60;
      return Math.max(1, Number(settings.longMin)) * 60;
    }
    function setMode(mode) {
      state.mode = mode;
      const dur = modeDurationSec(mode);
      state.remainSec = dur;
      state.endAt = 0;
      state.running = false;
      save(LS_STATE, state);
      updateUI();
    }
    
    // –§–æ–Ω–æ–≤—ã–µ —Ç–∞–π–º–µ—Ä—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã –≤ —Å–∫—Ä—ã—Ç–æ–π –≤–∫–ª–∞–¥–∫–µ
    let bgIntervalId = null;
    let endTimeoutId = null;
    
    function clearBgTimers() {
      if (bgIntervalId) { clearInterval(bgIntervalId); bgIntervalId = null; }
      if (endTimeoutId) { clearTimeout(endTimeoutId); endTimeoutId = null; }
    }
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–µ–¥–ª–∞–π–Ω–∞ ‚Äî –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –≤ setInterval/setTimeout –∏ –ø–æ visibilitychange
    function checkDeadline() {
      if (!state.running) return;
      const remainMs = state.endAt - Date.now();
      if (remainMs <= 0) {
        onComplete(false);
        return;
      }
      // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Å—Ç–∞—Ç–æ–∫ –∏ UI, —á—Ç–æ–±—ã –≤ —Ñ–æ–Ω–µ —Ç–∏–∫–∏ —Ç–æ–∂–µ —É—á–∏—Ç—ã–≤–∞–ª–∏—Å—å
      const sec = Math.max(0, Math.round(remainMs / 1000));
      if (sec !== state.remainSec) {
        state.remainSec = sec;
        save(LS_STATE, state);
        if (settings.tick && sec > 0) playBeep('tick');
      }
      updateUI();
    }
    
    function start() {
      ensureAudio(); // —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –∑–≤—É–∫
      if (state.running) return;
      const dur = modeDurationSec(state.mode);
      const base = (state.remainSec && state.remainSec > 0) ? state.remainSec : dur;
    
      state.endAt = Date.now() + base * 1000;
      state.running = true;
      save(LS_STATE, state);
      window.capNotify?.scheduleEndNotification(state.endAt, state.mode);
    
      playBeep('start');
      loop(); // rAF –¥–ª—è –∞–∫—Ç–∏–≤–Ω–æ–π –≤–∫–ª–∞–¥–∫–∏
    
      // –§–æ–Ω–æ–≤—ã–µ —Ç–∞–π–º–µ—Ä—ã –¥–ª—è —Å–∫—Ä—ã—Ç–æ–π –≤–∫–ª–∞–¥–∫–∏
      clearBgTimers();
      endTimeoutId = setTimeout(() => checkDeadline(), base * 1000 + 50);
      bgIntervalId = setInterval(checkDeadline, 1000);
    
      updateUI();
    }
    
    function pause() {
      if (!state.running) return;
      // –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –æ—Å—Ç–∞—Ç–æ–∫
      state.remainSec = Math.max(0, Math.round((state.endAt - Date.now()) / 1000));
      state.endAt = 0;
      state.running = false;
    
      clearBgTimers();
      window.capNotify?.cancelEndNotification();
      save(LS_STATE, state);
      updateUI();
    }
    
    function resetTimer() {
      state.remainSec = modeDurationSec(state.mode);
      state.endAt = 0;
      state.running = false;
    
      clearBgTimers();
      window.capNotify?.cancelEndNotification();
      save(LS_STATE, state);
      updateUI();
    }
    
    function skipNext() {
      // –∑–∞–≤–µ—Ä—à–∏—Ç—å —Ç–µ–∫—É—â—É—é –∏ –ø–µ—Ä–µ–π—Ç–∏ –∫ —Å–ª–µ–¥—É—é—â–µ–π
      onComplete(/*skip=*/true);
    }
    
    function loop() {
      if (!state.running) {
        updateUI(); // –æ—Ç—Ä–∏—Å–æ–≤–∞—Ç—å —Å—Ç–∞—Ç–∏—á–Ω–æ
        return;
      }
      const remain = Math.max(0, Math.round((state.endAt - Date.now()) / 1000));
      if (remain !== state.remainSec) {
        state.remainSec = remain;
        // –µ–∂–µ—Å–µ–∫—É–Ω–¥–Ω—ã–π —Ç–∏–∫
        if (settings.tick && remain > 0) playBeep('tick');
      }
      updateUI();
    
      if (remain <= 0) {
        onComplete(false);
        return;
      }
      requestAnimationFrame(loop);
    }
    
    function onComplete(skipped) {
      // –û—á–∏—â–∞–µ–º —Ñ–æ–Ω–æ–≤—ã–µ —Ç–∞–π–º–µ—Ä—ã —Ç–µ–∫—É—â–µ–π —Å–µ—Å—Å–∏–∏
      clearBgTimers();

      window.capNotify?.cancelEndNotification();
if (!skipped) {
  window.capNotify?.presentInstant(
    '–°–µ—Å—Å–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞',
    (state.mode === 'focus') ? '–û—Ç–ª–∏—á–Ω–∞—è —Ä–∞–±–æ—Ç–∞! –í—Ä–µ–º—è –æ—Ç–¥–æ—Ö–Ω—É—Ç—å.' : '–ü–µ—Ä–µ—Ä—ã–≤ –æ–∫–æ–Ω—á–µ–Ω. –í–ø–µ—Ä—ë–¥ –∫ —Ñ–æ–∫—É—Å—É!'
  );
}
    
      // –§–∏–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —Ä–µ–∂–∏–º
      const justMode = state.mode;
      const fullDur = modeDurationSec(justMode);
      const spent = Math.max(0, fullDur - state.remainSec);
    
      if (!skipped) {
        // –∑–≤—É–∫ –∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
        playBeep('end');
        notify('–°–µ—Å—Å–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞', justMode === 'focus' ? '–û—Ç–ª–∏—á–Ω–∞—è —Ä–∞–±–æ—Ç–∞! –í—Ä–µ–º—è –æ—Ç–¥–æ—Ö–Ω—É—Ç—å.' : '–ü–µ—Ä–µ—Ä—ã–≤ –æ–∫–æ–Ω—á–µ–Ω. –í–ø–µ—Ä—ë–¥ –∫ —Ñ–æ–∫—É—Å—É!');
      }
    
      if (justMode === 'focus') {
        state.cycleCount = (state.cycleCount + 1);
        state.todayPomos += 1;
        state.todayFocusSec += spent || fullDur;
    
        // –∑–∞—á–µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω–æ–π –∑–∞–¥–∞—á–µ
        if (state.activeTaskId) {
          const t = tasks.find(x => x.id === state.activeTaskId);
          if (t) t.pomosDone = (t.pomosDone || 0) + 1;
          save(LS_TASKS, tasks);
        }
      }
    
      // –í—ã–±–æ—Ä —Å–ª–µ–¥—É—é—â–µ–≥–æ —Ä–µ–∂–∏–º–∞
      let next = 'focus';
      if (justMode === 'focus') {
        next = (state.cycleCount % Number(settings.longEvery) === 0) ? 'long' : 'short';
      } else {
        next = 'focus';
      }
    
      state.mode = next;
      state.remainSec = modeDurationSec(next);
      state.endAt = 0;
      state.running = false;
    
      // —Å–º–µ–Ω–∏–ª—Å—è –¥–µ–Ω—å?
      state = normalizeState(state);
    
      save(LS_STATE, state);
      updateUI();
    
      if (settings.autostart) {
        start(); // —Å—Ç–∞—Ä—Ç—É–µ—Ç –Ω–æ–≤—ã–µ —Ñ–æ–Ω–æ–≤—ã–µ —Ç–∞–π–º–µ—Ä—ã
      }
    }
    
    // ---- –ó–∞–¥–∞—á–∏
    function renderTasks() {
      tasksWrap.innerHTML = '';
      if (!tasks.length) {
        const empty = document.createElement('div');
        empty.className = 'subnote';
        empty.textContent = '–ó–∞–¥–∞—á –ø–æ–∫–∞ –Ω–µ—Ç. –î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—É—é.';
        tasksWrap.appendChild(empty);
        updateSubnote();
        return;
      }
      for (const t of tasks) {
        const div = document.createElement('div');
        div.className = 'task' + (t.id === state.activeTaskId ? ' active' : '');
        // checkbox
        const chk = document.createElement('input');
        chk.type = 'checkbox';
        chk.checked = !!t.done;
        chk.onchange = () => {
          t.done = chk.checked;
          save(LS_TASKS, tasks);
          renderTasks();
        };
        // content
        const content = document.createElement('div');
        const title = document.createElement('div');
        title.className = 'title';
        title.textContent = t.title;
        const meta = document.createElement('div');
        meta.className = 'meta';
        meta.textContent = '–ü–æ–º–∏–¥–æ—Ä–æ–∫: ' + (t.pomosDone || 0);
        content.appendChild(title);
        content.appendChild(meta);
    
        const actions = document.createElement('div');
        actions.className = 'actions';
    
        const btnSel = document.createElement('button');
        btnSel.className = 'icon-btn';
        btnSel.textContent = t.id === state.activeTaskId ? '–ê–∫—Ç–∏–≤–Ω–æ' : '–°–¥–µ–ª–∞—Ç—å –∞–∫—Ç–∏–≤–Ω–æ–π';
        btnSel.onclick = () => {
          state.activeTaskId = t.id;
          save(LS_STATE, state);
          renderTasks();
        };
    
        const btnDel = document.createElement('button');
        btnDel.className = 'icon-btn';
        btnDel.textContent = '–£–¥–∞–ª–∏—Ç—å';
        btnDel.onclick = () => {
          const idx = tasks.findIndex(x => x.id === t.id);
          if (idx >= 0) tasks.splice(idx, 1);
          if (state.activeTaskId === t.id) state.activeTaskId = null;
          save(LS_TASKS, tasks);
          save(LS_STATE, state);
          renderTasks();
        };
    
        actions.appendChild(btnSel);
        actions.appendChild(btnDel);
    
        div.appendChild(chk);
        div.appendChild(content);
        div.appendChild(actions);
        tasksWrap.appendChild(div);
      }
      updateSubnote();
    }
    function addTask() {
      const title = (taskInput.value || '').trim();
      if (!title) return;
      const t = {
        id: crypto.randomUUID ? crypto.randomUUID() : String(Date.now()) + Math.random(),
        title, pomosDone: 0, done: false
      };
      tasks.unshift(t);
      if (!state.activeTaskId) state.activeTaskId = t.id;
      taskInput.value = '';
      save(LS_TASKS, tasks);
      save(LS_STATE, state);
      renderTasks();
    }
    
    // ---- UI –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
    function formatTime(sec) {
      const m = Math.floor(sec / 60);
      const s = Math.floor(sec % 60);
      return String(m).padStart(2,'0') + ':' + String(s).padStart(2,'0');
    }
    function updateSubnote() {
      const active = tasks.find(t => t.id === state.activeTaskId);
      const taskText = active ? active.title : '‚Äî';
      const modeText = state.mode === 'focus' ? '–§–æ–∫—É—Å' : (state.mode === 'short' ? '–ö–æ—Ä–æ—Ç–∫–∏–π –ø–µ—Ä–µ—Ä—ã–≤' : '–î–ª–∏–Ω–Ω—ã–π –ø–µ—Ä–µ—Ä—ã–≤');
      subnoteEl.textContent = modeText + '. –¢–µ–∫—É—â–∞—è –∑–∞–¥–∞—á–∞: ' + taskText;
    }
    function updateChips() {
      chipFocus.classList.toggle('active', state.mode === 'focus');
      chipShort.classList.toggle('active', state.mode === 'short');
      chipLong.classList.toggle('active', state.mode === 'long');
    }
    function updateRing() {
      const total = modeDurationSec(state.mode);
      const remain = state.running ? Math.max(0, Math.round((state.endAt - Date.now())/1000)) : state.remainSec;
      const progress = 1 - (remain / total);
      const r = 150;
      const C = 2 * Math.PI * r; // ~942
      ringFg.setAttribute('stroke-dasharray', String(C));
      ringFg.setAttribute('stroke-dashoffset', String(C * (1 - progress)));
      topBar.style.width = (progress * 100).toFixed(2) + '%';
    }
    function updateStats() {
      statToday.textContent = String(state.todayPomos);
      const sec = state.todayFocusSec;
      statFocusTime.textContent = formatTime(sec);
      statCycle.textContent = (state.cycleCount % Number(settings.longEvery) + 1) + ' / ' + settings.longEvery;
    }
    function updateButtons() {
      btnStartPause.textContent = state.running ? '–ü–∞—É–∑–∞' : '–°—Ç–∞—Ä—Ç';
    }
    function updateInputs() {
      inpFocus.value = settings.focusMin;
      inpShort.value = settings.shortMin;
      inpLong.value = settings.longMin;
      selEvery.value = String(settings.longEvery);
      chkAutostart.checked = !!settings.autostart;
      chkSound.checked = !!settings.sound;
      chkTick.checked = !!settings.tick;
      rngVolume.value = settings.volume;
      const isLight = settings.theme === 'light';
      document.body.classList.toggle('light', isLight);
      themeToggle.checked = isLight;
      themeLabel.textContent = isLight ? '–°–≤–µ—Ç–ª–∞—è' : '–¢—ë–º–Ω–∞—è';
    }
    function updateUI() {
      updateChips();
      updateRing();
      const remain = state.running ? Math.max(0, Math.round((state.endAt - Date.now())/1000)) : state.remainSec;
      timeEl.textContent = formatTime(remain);
      updateButtons();
      updateStats();
      updateSubnote();
      document.title = (state.mode === 'focus' ? 'üéØ' : '‚òï') + ' ' + timeEl.textContent + ' ‚Äî –ü–æ–º–æ–¥–æ—Ä–æ';
    }
    
    // ---- –°–æ–±—ã—Ç–∏—è UI
    chipFocus.onclick = () => setMode('focus');
    chipShort.onclick = () => setMode('short');
    chipLong.onclick = () => setMode('long');
    
    btnStartPause.onclick = () => state.running ? pause() : start();
    btnReset.onclick = () => resetTimer();
    btnSkip.onclick = () => skipNext();
    
    inpFocus.onchange = () => { settings.focusMin = clampInt(inpFocus.value, 1, 120); save(LS_SETTINGS, settings); if (!state.running && state.mode==='focus') resetTimer(); };
    inpShort.onchange = () => { settings.shortMin = clampInt(inpShort.value, 1, 60); save(LS_SETTINGS, settings); if (!state.running && state.mode==='short') resetTimer(); };
    inpLong.onchange  = () => { settings.longMin  = clampInt(inpLong.value, 1, 60); save(LS_SETTINGS, settings); if (!state.running && state.mode==='long') resetTimer(); };
    selEvery.onchange = () => { settings.longEvery = clampInt(selEvery.value, 2, 8); save(LS_SETTINGS, settings); updateStats(); };
    chkAutostart.onchange = () => { settings.autostart = chkAutostart.checked; save(LS_SETTINGS, settings); };
    chkSound.onchange = () => { settings.sound = chkSound.checked; save(LS_SETTINGS, settings); };
    chkTick.onchange = () => { settings.tick = chkTick.checked; save(LS_SETTINGS, settings); };
    rngVolume.oninput = () => { settings.volume = Number(rngVolume.value); save(LS_SETTINGS, settings); };
    
    btnTestSound.onclick = () => { ensureAudio(); playBeep('end'); };
    btnNotify.onclick = async () => {
  await window.capNotify?.initNotifications();
  await window.capNotify?.presentInstant('–ü—Ä–æ–≤–µ—Ä–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π', '–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —Ä–∞–±–æ—Ç–∞—é—Ç!');
};
    
    themeToggle.onchange = () => {
      settings.theme = themeToggle.checked ? 'light' : 'dark';
      save(LS_SETTINGS, settings);
      updateInputs();
      updateUI();
    };
    
    btnAddTask.onclick = addTask;
    taskInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') addTask();
    });
    
    // –ì–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏
    window.addEventListener('keydown', (e) => {
      if (['INPUT', 'TEXTAREA'].includes((e.target.tagName || '').toUpperCase())) return;
      if (e.code === 'Space') { e.preventDefault(); state.running ? pause() : start(); }
      if (e.code === 'KeyR') { e.preventDefault(); resetTimer(); }
      if (e.code === 'KeyN') { e.preventDefault(); skipNext(); }
      if (e.key === '1') setMode('focus');
      if (e.key === '2') setMode('short');
      if (e.key === '3') setMode('long');
    });
    
    // –ü—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ –Ω–∞ –≤–∫–ª–∞–¥–∫—É ‚Äî —Å—Ä–∞–∑—É —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º—Å—è
    document.addEventListener('visibilitychange', () => {
      if (document.visibilityState === 'visible') {
        checkDeadline();
      }
    });
    
    function clampInt(v, min, max) {
      const n = Math.floor(Number(v) || 0);
      return Math.max(min, Math.min(max, n));
    }
    
    // ---- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    function init() {
      window.capNotify?.initNotifications();
      // –ï—Å–ª–∏ —Ç–∞–π–º–µ—Ä –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–∞–ø—É—â–µ–Ω (–ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã)
      if (state.running && state.endAt > Date.now()) {
        loop(); // rAF –¥–ª—è –∞–∫—Ç–∏–≤–Ω–æ–π –≤–∫–ª–∞–¥–∫–∏
    
        // –ü–æ–¥–Ω—è—Ç—å —Ñ–æ–Ω–æ–≤—ã–µ —Ç–∞–π–º–µ—Ä—ã –Ω–∞ –æ—Å—Ç–∞—Ç–æ–∫
        clearBgTimers();
        const remain = Math.max(0, Math.round((state.endAt - Date.now()) / 1000));
        endTimeoutId = setTimeout(() => checkDeadline(), remain * 1000 + 50);
        bgIntervalId = setInterval(checkDeadline, 1000);
    
      } else if (state.running) {
        // –ø—Ä–æ—Å—Ä–æ—á–∏–ª—Å—è ‚Äî –∑–∞–≤–µ—Ä—à–∏—Ç—å
        onComplete(true);
      }
      updateInputs();
      renderTasks();
      updateUI();
    }
    init();
    </script>
</body>
</html>